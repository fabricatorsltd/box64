name: Update-Box64

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  update-box64:
    runs-on: ubuntu-24.04-arm

    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.ref }}

      - name: Build Box64 (glibc 2.31)
        uses: docker://arm64v8/ubuntu:20.04
        with:
          entrypoint: /bin/bash
          args: -lc "
            set -euo pipefail;
            export DEBIAN_FRONTEND=noninteractive;
            apt-get update;
            apt-get install -y git build-essential cmake ninja-build python3 wget curl file binutils pkg-config;
            echo 'GLIBC:'; ldd --version | head -n1;
            cd /github/workspace;
            bash docker-script.sh;
            mkdir -p /github/workspace/out;
            cp -r debian/*.deb /github/workspace/out/ || true;"

      - name: Compute tag and name
        id: vars
        run: |
          echo "TAG=box64-$(date +'%Y%m%d')" >> "$GITHUB_ENV"
          echo "RELNAME=Box64 $(date +'%Y-%m-%d')" >> "$GITHUB_ENV"

      - name: Debug artifacts
        run: |
          ls -l out || true

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          name: ${{ env.RELNAME }}
          body: "Automated build of Box64 with glibc 2.31 compatibility."
          files: out/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
